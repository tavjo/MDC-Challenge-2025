FROM python:3.12-slim

ENV UV_CACHE_DIR=/tmp/uv-cache \
    PYTHONUNBUFFERED=1

RUN pip install --no-cache-dir uv

# Set working directory
WORKDIR /app

# Install only the specific dependencies needed for the API service
# Using uv pip install instead of uv add for Docker builds (no project context needed)
COPY pyproject.toml uv.lock ./

RUN python -m venv --system-site-packages .venv \
    && . .venv/bin/activate \
    && uv pip install fastapi uvicorn duckdb chromadb sentence-transformers \
    llama-index llama-index-core llama-index-embeddings-openai openai \
    && uv sync --locked --inexact

# RUN uv pip install --system fastapi uvicorn duckdb chromadb sentence-transformers \
#     llama-index llama-index-core llama-index-embeddings-openai openai \
#     python-dotenv tiktoken pandas pytest pydantic pyyaml typing-extensions


# Expose venv on PATH for *all* subsequent RUN/CMD layers
ENV PATH="/app/.venv/bin:${PATH}"

# Copy necessary files
COPY src/ /app/src/
COPY api/ /app/api/
COPY configs/ /app/configs/

# Create necessary directories
RUN mkdir -p artifacts logs

# Run the API service
CMD ["uvicorn", "api.chunk_and_embed_api:app", "--host", "0.0.0.0", "--port", "8000"] 